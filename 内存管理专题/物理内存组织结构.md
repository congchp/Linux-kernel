# 体系结构
目前多处理器系统主要有两种体系结构。

（1）**非一致内存访问**（**Non-Uniform Memory Access，NUMA**）：指内存被划分成多个内存节点的多处理器系统，访问一个内存节点花费的时间取决于处理器和内存节点的距离。每个处理器有一个本地内存节点，处理器访问本地内存节点的速度比访问其他内存节点的速度快。 

![](https://cdn.nlark.com/yuque/0/2025/png/756577/1755651092236-ed8f1158-ebe9-4fdc-b54a-a5301304e9d3.png)

（2）**对称多处理器**（**Symmetric Multi-Processor，SMP**）：即一致内存访问（Uniform Memory Access，**UMA**），所有处理器访问内存花费的时间是相同的。每个处理器的地位是平等的，仅在内核初始化的时候不平等：“0号处理器作为引导处理器负责初始化内核，其他处理器等待内核初始化完成。”

在实际应用中可以采用混合体系结构，在NUMA节点内部使用SMP体系结构。

![](https://cdn.nlark.com/yuque/0/2025/png/756577/1755651109167-815741d6-7588-41a2-9c48-bae46abe5bef.png)

---

# 内存模型
Linux 内核内存子系统支持多种内存模型，以适应不同硬件架构和系统需求。以下是主要的内存模型及其特点：

---

（1）平坦内存（Flat Memory）：内存的物理地址空间是连续的，没有空洞。

（2）不连续内存（Discontiguous Memory）：内存的物理地址空间存在空洞，这种模型可以高效地处理空洞。

（3）稀疏内存（Sparse Memory）：内存的物理地址空间存在空洞。如果要支持内存热插拔，只能选择稀疏内存模型。

---

## 内核配置
通过`/boot/config-$(uname -r)`或者`/proc/config.gz`查询当前内存模型。

```bash
#平坦内存
CONFIG_FLATMEM=y
#稀疏内存
CONFIG_SPARSEMEM=y
```

# 内核物理内存组织结构
内存管理子系统使用节点(`Node`)，区域(`Zone`)、页(`Page`)三级结构描述物理内存。

Node，Zone和Page的关系可以用下图来描述

![画板](https://cdn.nlark.com/yuque/0/2025/jpeg/756577/1755571996577-fd40f7ec-4840-45fb-b1af-f80b9a965570.jpeg)

---

## 1. **Node (NUMA 节点)**
+ **背景**  
在多处理器系统（特别是 NUMA = Non-Uniform Memory Access 体系结构）中，物理内存不是均匀分布的，而是和 CPU 绑定形成“内存节点”。不同 CPU 访问不同节点的延迟和带宽不同。
+ **在内核中的表示**
    - 内核用 `struct pglist_data` 结构来表示一个内存节点（常简称 `pgdat`）。
    - 每个 **Node** 包含多个 **Zone**。
+ **单 CPU/UMA 系统**  
即使物理上只有一个内存区域，Linux 也会抽象出一个 Node 0，保持统一的框架。

```c
/*
 * The pg_data_t structure is used in machines with CONFIG_DISCONTIGMEM
 * (mostly NUMA machines?) to denote a higher-level memory zone than the
 * zone denotes.
 *
 * On NUMA machines, each NUMA node would have a pg_data_t to describe
 * it's memory layout.
 *
 * Memory statistics and page replacement data structures are maintained on a
 * per-zone basis.
 */
typedef struct pglist_data {
	struct zone node_zones[MAX_NR_ZONES]; // node中的zone数组
	struct zonelist node_zonelists[MAX_ZONELISTS]; // node的备用zone list
	int nr_zones; // node中zone数目

    struct page *node_mem_map; // 页描述符数组

    unsigned long node_start_pfn; // 起始物理页号
	unsigned long node_present_pages; /* total number of physical pages */
	unsigned long node_spanned_pages; /* total size of physical page
					     range, including holes */
	int node_id;
    ...
} pg_data_t;
```

---

## 2. **Zone (内存分区)**
+ **背景**  
内存硬件和历史兼容性导致不同内存区域有不同用途。比如：
    - DMA 设备只能寻址低端内存；
    - 内核常驻内存需要低端可直接映射的内存；
    - 高端内存只能通过 kmap 或 vmalloc 访问。
+ **在内核中的主要 Zone 类型**（不同架构略有差别）：
    - **ZONE_DMA**: 低端内存，供某些只能访问 16MB 或 32MB 内存的 DMA 设备使用。
    - **ZONE_NORMAL**: 正常内存，内核直接映射，通常存放内核数据结构、内核堆、直接分配的页框。
    - **ZONE_HIGHMEM**（仅部分 32bit 系统有）: 高端内存，内核无法永久直接映射，只能临时映射。
    - **ZONE_MOVABLE**: 供页面迁移（page migration）和大页分配使用。

```c
enum zone_type {
#ifdef CONFIG_ZONE_DMA
	/*
	 * ZONE_DMA is used when there are devices that are not able
	 * to do DMA to all of addressable memory (ZONE_NORMAL). Then we
	 * carve out the portion of memory that is needed for these devices.
	 * The range is arch specific.
	 *
	 * Some examples
	 *
	 * Architecture		Limit
	 * ---------------------------
	 * parisc, ia64, sparc	<4G
	 * s390			<2G
	 * arm			Various
	 * alpha		Unlimited or 0-16MB.
	 *
	 * i386, x86_64 and multiple other arches
	 * 			<16M.
	 */
	ZONE_DMA,
#endif
#ifdef CONFIG_ZONE_DMA32
	/*
	 * x86_64 needs two ZONE_DMAs because it supports devices that are
	 * only able to do DMA to the lower 16M but also 32 bit devices that
	 * can only do DMA areas below 4G.
	 */
	ZONE_DMA32,
#endif
	/*
	 * Normal addressable memory is in ZONE_NORMAL. DMA operations can be
	 * performed on pages in ZONE_NORMAL if the DMA devices support
	 * transfers to all addressable memory.
	 */
	ZONE_NORMAL,
#ifdef CONFIG_HIGHMEM
	/*
	 * A memory area that is only addressable by the kernel through
	 * mapping portions into its own address space. This is for example
	 * used by i386 to allow the kernel to address the memory beyond
	 * 900MB. The kernel will set up special mappings (page
	 * table entries on i386) for each page that the kernel needs to
	 * access.
	 */
	ZONE_HIGHMEM,
#endif
	ZONE_MOVABLE,
#ifdef CONFIG_ZONE_DEVICE
	ZONE_DEVICE,
#endif
	__MAX_NR_ZONES

};
```

+ **在内核中的表示**
    - 每个 `zone` 对应一个 `struct zone`。
    - 一个 **Node** 内包含多个 **Zone**。

---

## 3. **Page (物理页框)**
+ **背景**  
Linux 以 **页 (page)** 为基本单位来管理内存。
    - 典型大小：4KB（x86、ARM 常见），也有 2MB (hugepage)、1GB (gigantic page)。
+ **在内核中的表示**
    - 每个物理页对应一个 `struct page` 结构体。
    - **页的元数据**存放在 vmemmap 区域，数组形式存储，索引就是物理页号 (PFN)。
+ **用途**
    - 页可用于用户态进程（匿名内存、文件映射等）；
    - 内核自身分配（slab/slub/kmalloc）；
    - 页缓存 (page cache) 等。

---

## 4. **层次关系**
可以总结为：

```plain
系统内存
 └── Node (pglist_data)
       └── Zone (ZONE_DMA, ZONE_NORMAL, ZONE_HIGHMEM, ...)
             └── Page (struct page 数组中的一个元素)
```

+ **Node**: NUMA 视角划分
+ **Zone**: 功能/用途划分
+ **Page**: 最小分配/管理单位

---

## 5. **Sample**
假设一个 32 位 x86 机器，物理内存 4GB：

+ Node: 只有 Node 0
+ Zone:
    - ZONE_DMA: 0–16MB
    - ZONE_NORMAL: 16MB–896MB
    - ZONE_HIGHMEM: 896MB–4GB
+ Page: 4KB 为单位，总共 1M 个 page，每个 page 都有一个 `struct page` 来管理。

---

## Node，Zone，Page查询
### `/proc/zoneinfo`
通过`/proc/zoneinfo`显示**<font style="color:rgb(64, 64, 64);">每个 Node 的每个 Zone</font>**<font style="color:rgb(64, 64, 64);"> 的极度详细的状态信息。</font>

```bash
bran@bran-VirtualBox:~$ cat /proc/zoneinfo
Node 0, zone      DMA
  per-node stats
      nr_inactive_anon 504344
      nr_active_anon 112034
      nr_inactive_file 229256
      nr_active_file 28332
      nr_unevictable 0
      nr_slab_reclaimable 34119
      nr_slab_unreclaimable 24795
      nr_isolated_anon 0
      nr_isolated_file 0
      workingset_nodes 4006
      workingset_refault_anon 20248
      workingset_refault_file 208087
      workingset_activate_anon 20212
      workingset_activate_file 6741
      workingset_restore_anon 0
      workingset_restore_file 2762
      workingset_nodereclaim 640
      nr_anon_pages 608702
      nr_mapped    75684
      nr_file_pages 269592
      nr_dirty     12
      nr_writeback 0
      nr_writeback_temp 0
      nr_shmem     5586
      nr_shmem_hugepages 0
      nr_shmem_pmdmapped 0
      nr_file_hugepages 0
      nr_file_pmdmapped 0
      nr_anon_transparent_hugepages 0
      nr_vmscan_write 48590
      nr_vmscan_immediate_reclaim 0
      nr_dirtied   40334
      nr_written   83710
      nr_throttled_written 0
      nr_kernel_misc_reclaimable 0
      nr_foll_pin_acquired 0
      nr_foll_pin_released 0
      nr_kernel_stack 9112
      nr_page_table_pages 13311
      nr_sec_page_table_pages 0
      nr_iommu_pages 0
      nr_swapcached 6417
      pgpromote_success 0
      pgpromote_candidate 0
      pgdemote_kswapd 0
      pgdemote_direct 0
      pgdemote_khugepaged 0
      nr_hugetlb   0
  pages free     3712
        boost    0
        min      77
        low      96
        high     115
        promo    134
        spanned  4095
        present  3998
        managed  3840
        cma      0
        protection: (0, 3468, 3907, 3907, 3907)
      nr_free_pages 3712
      nr_zone_inactive_anon 0
      nr_zone_active_anon 0
      nr_zone_inactive_file 0
      nr_zone_active_file 0
      nr_zone_unevictable 0
      nr_zone_write_pending 0
      nr_mlock     0
      nr_bounce    0
      nr_zspages   0
      nr_free_cma  0
      nr_unaccepted 0
      numa_hit     1
      numa_miss    0
      numa_foreign 0
      numa_interleave 1
      numa_local   1
      numa_other   0
  pagesets
    cpu: 0
              count:    0
              high:     0
              batch:    1
              high_min: 24
              high_max: 120
  vm stats threshold: 6
    cpu: 1
              count:    0
              high:     0
              batch:    1
              high_min: 24
              high_max: 120
  vm stats threshold: 6
    cpu: 2
              count:    0
              high:     0
              batch:    1
              high_min: 24
              high_max: 120
  vm stats threshold: 6
    cpu: 3
              count:    0
              high:     0
              batch:    1
              high_min: 24
              high_max: 120
  vm stats threshold: 6
  node_unreclaimable:  0
  start_pfn:           1
Node 0, zone    DMA32
  pages free     31689
        boost    0
        min      14550
        low      18187
        high     21824
        promo    25461
        spanned  1044480
        present  913392
        managed  887811
        cma      0
        protection: (0, 0, 439, 439, 439)
      nr_free_pages 31689
      nr_zone_inactive_anon 486763
      nr_zone_active_anon 88935
      nr_zone_inactive_file 201494
      nr_zone_active_file 14639
      nr_zone_unevictable 0
      nr_zone_write_pending 8
      nr_mlock     0
      nr_bounce    0
      nr_zspages   0
      nr_free_cma  0
      nr_unaccepted 0
      numa_hit     2723545
      numa_miss    0
      numa_foreign 0
      numa_interleave 575
      numa_local   2723545
      numa_other   0
  pagesets
    cpu: 0
              count:    3036
              high:     4546
              batch:    63
              high_min: 4546
              high_max: 22562
  vm stats threshold: 36
    cpu: 1
              count:    4177
              high:     4546
              batch:    63
              high_min: 4546
              high_max: 22562
  vm stats threshold: 36
    cpu: 2
              count:    60
              high:     4609
              batch:    63
              high_min: 4546
              high_max: 22562
  vm stats threshold: 36
    cpu: 3
              count:    69
              high:     4609
              batch:    63
              high_min: 4546
              high_max: 22562
  vm stats threshold: 36
  node_unreclaimable:  0
  start_pfn:           4096
Node 0, zone   Normal
  pages free     2821
        boost    0
        min      2267
        low      2833
        high     3399
        promo    3965
        spanned  131072
        present  131072
        managed  112539
        cma      0
        protection: (0, 0, 0, 0, 0)
      nr_free_pages 2821
      nr_zone_inactive_anon 17581
      nr_zone_active_anon 23099
      nr_zone_inactive_file 27762
      nr_zone_active_file 13693
      nr_zone_unevictable 0
      nr_zone_write_pending 4
      nr_mlock     0
      nr_bounce    0
      nr_zspages   0
      nr_free_cma  0
      nr_unaccepted 0
      numa_hit     555833
      numa_miss    0
      numa_foreign 0
      numa_interleave 787
      numa_local   555833
      numa_other   0
  pagesets
    cpu: 0
              count:    160
              high:     708
              batch:    31
              high_min: 708
              high_max: 3516
  vm stats threshold: 18
    cpu: 1
              count:    653
              high:     708
              batch:    31
              high_min: 708
              high_max: 3516
  vm stats threshold: 18
    cpu: 2
              count:    0
              high:     832
              batch:    31
              high_min: 708
              high_max: 3516
  vm stats threshold: 18
    cpu: 3
              count:    0
              high:     832
              batch:    31
              high_min: 708
              high_max: 3516
  vm stats threshold: 18
  node_unreclaimable:  0
  start_pfn:           1048576
Node 0, zone  Movable
  pages free     0
        boost    0
        min      32
        low      32
        high     32
        promo    32
        spanned  0
        present  0
        managed  0
        cma      0
        protection: (0, 0, 0, 0, 0)
Node 0, zone   Device
  pages free     0
        boost    0
        min      0
        low      0
        high     0
        promo    0
        spanned  0
        present  0
        managed  0
        cma      0
        protection: (0, 0, 0, 0, 0)

```

### `/proc/pid/pagemap`，`/proc/kpagecount`，`/proc/kpageflags`
`**/proc/kpagecount**`、`**/proc/kpageflags**`、`**/proc/[pid]/pagemap**`，都是 Linux 为了用户态研究 **物理页 (page frame)** 与 **虚拟地址 (VA)** 映射关系而提供的底层接口。

#### PFN 概念
+ **PFN (Page Frame Number)** = 物理页号
+ 内核里每个物理页框都有唯一的 PFN = 物理地址 >> PAGE_SHIFT
+ `/proc/kpage*` 文件都是以 **PFN 为索引**的。

---

#### 各文件作用
详细的作用参考`Documentation/vm/pagemap.txt`

+ `**/proc/[pid]/pagemap**`**，**显示该进程 **虚拟页号 (VPN)** 到 **物理页号 (PFN)** 的映射
+ `**/proc/kpagecount**`**， **显示**这个 PFN 的引用计数**
    - 条目编号 = PFN
    - **值 = 该物理页被多少个 PTE（Page Table Entry）映射**
+ `**/proc/kpageflags**`**，**<font style="color:rgb(64, 64, 64);">显示每个页面的标志位（如是否脏页、是否被锁定等）</font>

#### 使用方法
1. 先通过 `/proc/[pid]/maps` 确定一个用户虚拟地址范围
2. 计算 VPN = vaddr / PAGE_SIZE
3. 到 `/proc/[pid]/pagemap` 查询对应的PFN
4. PFN 结合 `/proc/kpageflags` 或 `/proc/kpagecount` 获取该物理页详细信息



※这3各文件输出的都是二进制内容，需要专门的工具解析。

# <font style="color:rgb(38, 38, 38);">参考资料</font>
1. <font style="color:rgb(64, 64, 64);">Professional Linux Kernel Architecture，Wolfgang Mauerer</font>
2. <font style="color:rgb(64, 64, 64);">Linux内核深度解析，余华兵</font>
3. <font style="color:rgb(64, 64, 64);">Linux设备驱动开发详解，宋宝华</font>
4. <font style="color:rgb(64, 64, 64);">linux kernel 4.12</font>



